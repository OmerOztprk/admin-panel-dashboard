<div class="page-wrap">
  <h1 class="page-title gradient-text">Audit Logs</h1>

  <div class="app-card with-accent">
    <div class="card-header">
      <button class="back-btn" type="button" (click)="goBack()" aria-label="Back">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6" />
        </svg>
        <span>Back</span>
      </button>

      <div class="header-actions">
        <button class="btn--ghost btn--sm" type="button" (click)="toggleFilters()">
          {{ filterOpen() ? 'Hide Filters' : 'Show Filters' }}
        </button>
      </div>
    </div>

    <section class="filters" *ngIf="filterOpen()">
      <form [formGroup]="form" (ngSubmit)="applyFilters()" class="filters-form">
        <div class="form-row">
          <div class="input-group">
            <label for="fUser">User</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
              </span>
              <input id="fUser" type="text" formControlName="user" placeholder="Name or 'First Last'">
            </div>
          </div>
          <div class="input-group">
            <label for="fAction">Action</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M5 12h14" />
                  <path d="M12 5l7 7-7 7" />
                </svg>
              </span>
              <input id="fAction" type="text" formControlName="action" placeholder="e.g. login">
            </div>
          </div>
          <div class="input-group">
            <label for="fResource">Resource</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="14" rx="2" />
                  <path d="M3 10h18" />
                </svg>
              </span>
              <input id="fResource" type="text" formControlName="resource" placeholder="e.g. user, role">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="input-group">
            <label for="fStatus">Status</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M9 12l2 2 4-4" />
                </svg>
              </span>
              <select id="fStatus" formControlName="status">
                <option value="">All</option>
                <option value="success">Success</option>
                <option value="failure">Failure</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label for="fFrom">From</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="18" rx="2" />
                  <path d="M16 2v4M8 2v4M3 10h18" />
                </svg>
              </span>
              <input id="fFrom" type="date" formControlName="from">
            </div>
          </div>
          <div class="input-group">
            <label for="fTo">To</label>
            <div class="input-wrapper">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="18" rx="2" />
                  <path d="M16 2v4M8 2v4M3 10h18" />
                </svg>
              </span>
              <input id="fTo" type="date" formControlName="to">
            </div>
          </div>
        </div>

        <div class="filters-actions">
          <button class="btn--ghost btn--sm" type="button" (click)="resetFilters()"
            [disabled]="loading()">Reset</button>
          <button class="btn--ghost btn--sm" type="submit" [disabled]="loading()">Apply</button>
        </div>
      </form>
      <div class="divider"></div>
    </section>

    <div class="alert alert-error" *ngIf="error()" aria-live="assertive">
      <span class="alert__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </span>
      {{ error() }}
    </div>

    <ng-container *ngIf="!loading(); else loadingTpl">
      <div class="data-table-wrap" *ngIf="logs().length; else emptyTpl">
        <div class="data-table">
          <div class="data-head">
            <div class="data-cell">User</div>
            <div class="data-cell">Action</div>
            <div class="data-cell">Resource</div>
            <div class="data-cell">Date</div>
            <div class="data-cell">Status</div>
            <div class="data-cell">Actions</div>
          </div>

          <div class="data-row" *ngFor="let l of logs(); trackBy: trackById">
            <div class="data-cell" data-label="User">
              <span class="truncate muted">{{ userLabel(l) }}</span>
            </div>
            <div class="data-cell" data-label="Action">
              <span class="truncate">{{ l.action }}</span>
            </div>
            <div class="data-cell" data-label="Resource">
              <span class="truncate">{{ l.resource }}</span>
            </div>
            <div class="data-cell" data-label="Date">
              <span class="truncate">{{ l.createdAt | date:'short' }}</span>
            </div>
            <div class="data-cell" data-label="Status">
              <span [class]="statusChip(l)"><span class="dot"></span>{{ l.status }}</span>
            </div>
            <div class="data-cell" data-label="Actions">
              <button class="btn--ghost btn--sm" type="button" (click)="view(l._id)">View</button>
            </div>
          </div>
        </div>
      </div>

      <nav class="pagination" *ngIf="meta()" aria-label="Pagination">
        <div class="pagination-controls" *ngIf="meta()!.totalPages > 1">
          <button class="btn--ghost btn--sm" type="button" [disabled]="!hasPrev()"
            (click)="changePage(meta()!.page - 1)">Previous</button>
          <span class="page-info">Page {{ meta()!.page }} of {{ meta()!.totalPages }}</span>
          <button class="btn--ghost btn--sm" type="button" [disabled]="!hasNext()"
            (click)="changePage(meta()!.page + 1)">Next</button>
        </div>
        <div class="pagination-meta">
          <div class="meta-chip">Total: <strong>{{ meta()!.total }}</strong></div>
          <div class="meta-chip" *ngIf="meta()!.totalPages > 1">Page <strong>{{ meta()!.page }}</strong> / {{
            meta()!.totalPages }}</div>
        </div>
      </nav>
    </ng-container>
  </div>
</div>

<ng-template #emptyTpl>
  <div class="alert alert-info" aria-live="polite">No audit logs found.</div>
</ng-template>

<ng-template #loadingTpl>
  <div class="app-card with-accent skeleton">
    <div class="skeleton-line wide"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line half"></div>
  </div>
</ng-template>